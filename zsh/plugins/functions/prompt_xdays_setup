#
# Prezto prompt theme with AWS profile, Kubernetes context/namespace, and git branch.
#

# Load dependencies.
pmodload 'helper'

prompt_xdays_segment() {
  local label=$1
  local value=$2
  local color=$3

  if [[ -n "$value" ]]; then
    print -r -- "%F{${color}}[${label}:${value}]%f "
  fi
}

prompt_xdays_git_branch() {
  if command git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD 2>/dev/null
  fi
}

prompt_xdays_kube_context() {
  if command -v kubectl >/dev/null 2>&1; then
    kubectl config current-context 2>/dev/null
  fi
}

prompt_xdays_kube_namespace() {
  if command -v kubectl >/dev/null 2>&1; then
    kubectl config view --minify --output 'jsonpath={..namespace}' 2>/dev/null
  fi
}

prompt_xdays_precmd() {
  setopt LOCAL_OPTIONS
  unsetopt XTRACE KSH_ARRAYS

  _prompt_xdays_pwd=$(prompt-pwd)

  _prompt_xdays_aws=''
  if [[ -n "$AWS_PROFILE" ]]; then
    _prompt_xdays_aws=$(prompt_xdays_segment aws "$AWS_PROFILE" 6)
  fi

  _prompt_xdays_k8s=''
  local kctx kns
  kctx=$(prompt_xdays_kube_context)
  if [[ -n "$kctx" ]]; then
    kns=$(prompt_xdays_kube_namespace)
    [[ -z "$kns" ]] && kns=default
    _prompt_xdays_k8s=$(prompt_xdays_segment k8s "${kctx}/${kns}" 5)
  fi

  _prompt_xdays_git=''
  local gbranch
  gbranch=$(prompt_xdays_git_branch)
  if [[ -n "$gbranch" ]]; then
    _prompt_xdays_git=$(prompt_xdays_segment git "$gbranch" 2)
  fi
}

prompt_xdays_setup() {
  setopt LOCAL_OPTIONS
  unsetopt XTRACE KSH_ARRAYS
  prompt_opts=(cr percent sp subst)

  autoload -Uz add-zsh-hook
  add-zsh-hook precmd prompt_xdays_precmd

  zstyle ':prezto:module:prompt' managed 'yes'

  _prompt_xdays_pwd=''
  _prompt_xdays_aws=''
  _prompt_xdays_k8s=''
  _prompt_xdays_git=''

  PROMPT='${_prompt_xdays_aws}${_prompt_xdays_k8s}${_prompt_xdays_git}%F{4}${_prompt_xdays_pwd}%f $ '
  RPROMPT=''
}

prompt_xdays_setup "$@"
# vim: ft=zsh
